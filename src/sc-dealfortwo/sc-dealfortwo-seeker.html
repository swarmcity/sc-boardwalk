<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/sc-style/sc-style.html">
<link rel="import" href="../../bower_components/sc-iconset/sc-iconset.html">
<link rel="import" href="../../bower_components/moment-js/moment-js.html">

<link rel="import" href="../sc-payout/sc-payout.html">
<link rel="import" href="../sc-avatar/sc-avatar.html">
<link rel="import" href="../sc-username/sc-username.html">
<link rel="import" href="../sc-dealchat/sc-dealchat.html">
<link rel="import" href="../sc-dealstate/sc-dealstate.html">
<link rel="import" href="../sc-redux/sc-redux.html">
<link rel="import" href="../sc-shh/sc-shh.html">
<link rel="import" href="../sc-config/sc-config.html">
<link rel="import" href="../sc-helpers/sc-helpers.html">
<link rel="import" href="../sc-loader/sc-loader.html">
<!-- <link rel="import" href="../sc-hashtagcontract/sc-hashtagcontract.html">
 -->
<link rel="import" href="../sc-dealfortwo/sc-dealfortwo.html">
<link rel="import" href="../sc-listeners/sc-listeners.html">
<link rel="import" href="../sc-hashtagitem/sc-hashtagitem.html">
<link rel="import" href="../sc-tokenbalanceformatter/sc-tokenbalanceformatter.html">


<!--<link rel="import" href="../sc-balance/sc-balance.html"> -->


<!--
`sc-dealfortwo-seeker`

This components allows 2 Swarm Citizens to make a deal with eachother, based on the request of the service-seeker.

@demo src/sc-dealfortwo-seeker/demo/index.html
-->

<dom-module id="sc-dealfortwo-seeker">

  <template>
<style include="sc-styles">
      :host {
        display: block;
        height: 100%;
        width: 100%;
      }

      neon-animated-pages {
        height: 100%;
        width: 100%;
      }

      .fullheight {
        height: 100%;
      }

      .topbar {
        height: 10vh;
      }

      .totalbox {
        width: 100%;
      }

      .tophalf {
        min-height: 55vh;
        padding: 6vh 10vw 6vh 10vw;
        @apply(--layout-vertical);
        @apply(--layout-start-justified);
        @apply(--layout-start);
      }

      .tophalf h1 {
        font-size: 40px;
        line-height: 48px;
        max-width: 75%;
      }

      .withconfirmq {
        min-height: 50vh;
      }

      .bottomhalfÂ {
        height: 35vh;
        box-sizing:border-box;
        padding: 0px 10vw 0px 10vw;
        @apply(--layout-horizontal);
        @apply(--layout-start-justified);
        @apply(--layout-center);
        transition: all 0.1s linear;

      }



      .accepter {
        width: 100%;
        @apply(--layout-horizontal);
        @apply(--layout-start-justified);
        @apply(--layout-center);
      }

/*
      .box {
        width: 50%;
      }


      .amountwaiting {
        opacity: 0.15;
      }


      .amountconfirmed {
        opacity: 1;
      }



      .dealamountio {
        margin-top: 10px;
        margin-left: -35px;
        margin-right: -35px;
        @apply(--layout-vertical-reverse);
        @apply(--layout-center-center);
      }

      .dealamountio p {
        font-size: 22px;
        line-height: 24px;
        margin-top: 10px;
      }
*/
      .SWTletters {
        font-size: 10px;
        line-height: 12px;
      }

      sc-dealchat {
        width: 100%;
        height: 100%;
      }



      .announce {
        box-sizing:border-box;
        padding: 4vw 0px 2vw 0px;
        @apply(--layout-horizontal);
        @apply(--layout-center);
        @apply(--layout-start-justified);
      }


      .details_toggler {
        padding: 0px;
        font-size: 14px;
        margin: 20px 0px 20px 0px;
        @apply(--layout-horizontal);
        @apply(--layout-center);
        @apply(--layout-start-justified);
      }
      .details_toggler p {
        border-bottom: 1px dotted #bfbfbf;
      }

      .details_toggler:hover {
        cursor: pointer;
      }


      #details_collapser {
        width: 100%;
      }


      .details_collapser_inner {
        width: 100%;
        @apply(--layout-vertical);
        @apply(--layout-start);
        @apply(--layout-start-justified);
        border-top: 1px dotted var(--sc-grey2);
        border-bottom: 1px dotted var(--sc-grey2);
        box-sizing:border-box;
        padding: 20px;
        margin-bottom: 25px;
      }

      .details_collapser_inner {
        font-size: 14px;
        line-height: 20px;
      }

/*      .detail_step {
        box-sizing:border-box;
        padding-bottom: 6px;
      }*/

      .detail {
        margin-bottom: 10px;
        color: var(--sc-grey3);
        width: 100%;
        @apply(--layout-horizontal);
        @apply(--layout-start);
        @apply(--layout-start-justified);

      }


      .detail p {
        font-size: 14px;
        line-height: 18px;
      }

      .detail a {
        font-size: 14px;
        line-height: 18px;
      }

      .cat {
        /*margin-top: 4px;*/

        font-family: montserratlight;
        color: var(--sc-grey3);
        width: 50%;
        max-width: 100px;
        text-align: right;
        margin-right: 10px;
      }


/*      .detail_step iron-icon {
        margin-right: 10px;
      }

      .detail_step p {
        margin-top: 4px;
        font-size: 14px;
        line-height: 18px;
      }

      .detail_step a {
        font-size: 12px;
        font-family: montserratsemibold;
      }

      .details_avatars {
        margin-right: 10px;
      }
*/


      .announce paper-button{
        margin-left: 2vw;
      }


      .confirmbtns {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        @apply(--layout-end-justified);
        margin-left: 2vw;

      }

      paper-icon-button.confirmbtn {
          /*margin-top: -40px;*/
          margin-right: 6vw;
          width: 80px;
          height: 80px;
      }

      paper-icon-button.confirmbtn.blue {
          background-color: #36B7FF;
          box-sizing:border-box;
          padding: 8px;
      }

      paper-icon-button.confirmbtn.green {
          background-color: #8ADEA9;
      }

      paper-button.confirmbtn.green {
          background-color: #8ADEA9;
      }


      paper-button.blue {
          background-color: #36B7FF;
      }

      paper-icon-button.confirmbtn.red {
        background-color: #f66a6a;
      }


      paper-button.payoutbtn {
        font-size: 20px;
      }

      .payoutbtn iron-icon {
        margin-left: 6px;
      }

      .dealid {
        font-size: 36px;
        line-height: 40px;
      }

      .avatars_funding {
        box-sizing:border-box;
        padding: 0px;
        @apply(--layout-horizontal);
        @apply(--layout-start);
        @apply(--layout-start-justified);
        @apply(--layout-wrap);
        margin-bottom: 2vw;
        margin-top: 4vh;
      }


      .avatar_funding {
        box-sizing:border-box;
        padding: 0px;
        @apply(--layout-vertical);
        @apply(--layout-center);
        @apply(--layout-center-justified);
        margin-right: 10px;
      }



      .divider {
        height: 100%;
        width: 2px;
        border-left: 2px dotted var(--sc-grey2);
        margin: 0px 50px;
      }


      .funding {
        margin-left: 12px;
      }

      .funding p {
        font-size: 40px;
        line-height: 42px;
      }

      .swtletters {
        font-size: 16px;
        line-height: 20px;
      }

/*      .v_icon {
        margin: 12px 0px 0px 6px;
      }*/

      .fund_init p {
        opacity: 0.35;
        color: var(--sc-grey2);
      }


      .fund_init iron-icon {
        opacity: 0.35;
        color: var(--sc-grey2);
      }

      .fund_accepted p {
        opacity: 1;
        color: var(--sc-grey3);
      }

      .fund_accepted iron-icon {
        opacity: 1;
        color: var(--sc-green);
      }




      .replyer_username {
        border-bottom: 1px dotted var(--sc-blue);
      }

      .announce_amount {
        font-size: 12px;
        line-height: 16px;
      }

      .acceptbtn {
        padding: 18px 22px 18px 34px;
        margin-right: 30px;
      }

      .dealmsg {
        box-sizing:border-box;
        padding: 10px 0px;


      }

      .decliner {
        opacity: 0.65;
        margin-right: 10px;
      }

      .confirmation_question {
        font-size: 24px;
        line-height: 26px;
        text-align: right;
      }
      .dealcreate_steps {
/*        background-color: rgba(36,177,255,0.1);*/

        box-sizing:border-box;
        padding: 10px 10px 10px 0px;
        /*max-width: 300px;*/

/*        border-top: 2px dotted rgba(0,0,0,0.05);
        border-bottom: 2px dotted rgba(0,0,0,0.05);*/

        border-top: 2px dotted rgba(36,177,255,0.5);
        border-bottom: 2px dotted rgba(36,177,255,0.5);
      }


      .triangle {
        width: 12px;
        transition: all 0.075s linear;
        margin-right: 10px;
        margin-left: 2px;
        opacity: 1;
      }

      .triangle svg {
        width: 100%;
      }

      .opened {
        transform: rotate(90deg);
        opacity: 0.75;
      }


      .grey2b {
        color: #999999;
        margin-left: 4px;
      }

      .allsteps {
        width: 100%;
        height: 100%;
        @apply(--layout-vertical);
        @apply(--layout-start);
        @apply(--layout-start-justified);
        box-sizing:border-box;
        padding: 10px 0px 10px 0px;
      }

      .step {
        box-sizing:border-box;
        padding: 0px 0px 2px 28px;
      }
      .step p {
        font-size: 14px;
        line-height: 20px;
        margin-right: 12px;
      }

      .stepinit {
        color: var(--sc-grey2);
      }

      .stepdone p {
        font-family: montserrat;
        color: var(--sc-grey3);
      }

      .stepdone iron-icon {
        color: var(--sc-green);
      }
/*      .creatingadeal {
        font-family: montserratlight;
        font-size: 22px;
        line-height: 26px;
      }
*/

      .chatbtn {
        @apply(--layout-self-end)
      }

      paper-icon-button.chatbtn_iconbtn {
        width: 52px;
        height: 52px;
        min-width: 52px;
        min-height: 52px;
        padding: 12px;
        margin-left: 10px;
      }

      .halfopacity {
        opacity: 0.5;
      }

        .dealid {
          width: 80px;
        }

        .dealid p {
          @apply(--sc-font-nowrap);
        }

        .approver {
          width: 100vw;
          height: 100vh;
          padding: 0px;
          margin: 0px;
          @apply(--layout-vertical);
          @apply(--layout-start-justified);
          @apply(--layout-start);
        }


        .approver_inner {
          width: 100%;
          height: 90vh;
          box-sizing:border-box;
          padding: 18vh 10vw 6vh 10vw;
          @apply(--layout-vertical);
          @apply(--layout-start-justified);
          @apply(--layout-center);
        }


        .approver_confirmbtns {
          width: 100%;
          @apply(--layout-horizontal);
          @apply(--layout-center-justified);
          @apply(--layout-center);
        }

        .accepted-container {
          @apply(--layout-vertical);
          margin-left: -10vw;
          margin-right: -10vw;
          flex-grow: 1;
          align-self: stretch;
        }

        .accepted-container > * {
          padding-left: 10vw;
          padding-right: 10vw;
        }

        .cancel-container {
          @apply(--layout-horizontal);
          @apply(--layout-end-justified);
          align-items: center;
          flex-grow: 2;
        }

        .waiting-msg {
          @apply(--layout-center);
          flex-grow: 1;
        }


/*
        paper-button.chatbtn_big {
          opacity: 0.75;
          font-size: 14px;

          border-radius: 0px;
          padding: 0px;
          border-bottom: 2px dotted var(--sc-grey4);

        }

        paper-button.chatbtn_big iron-icon {
          margin:0px 0px 2px 4px;
        }
*/

/*        .underline {
          padding-bottom: 4px;
          text-decoration: underline;
        }*/

    @media all and (min-width: 0) and (max-width: 420px) {


      .tophalf {
        min-height: 50vh;
        padding: 6vh 12vw 8vh 12vw;
        @apply(--layout-vertical);
        @apply(--layout-start-justified);
        @apply(--layout-start);
      }


      .bottomhalfÂ {
        min-height: 40vh;
        @apply(--layout-vertical);
        @apply(--layout-center);
        @apply(--layout-start-justified);
        padding-top: 8vh;
      }


      .announce {
        box-sizing:border-box;
        padding: 11vw 0px 2vw 0px;
      }

      .tophalf h1 {
          font-size: 32px;
          line-height: 38px;
          max-width: 100%;
        }

      .confirmbtns {
        width: 100%;
        @apply(--layout-horizontal);
        @apply(--layout-center);
        @apply(--layout-center-justified);
        margin-left: 0px;
      }

      paper-icon-button.confirmbtn,
      paper-icon-button.cancelbtn{
          width: 72px;
          height: 72px;
          padding: 14px;
      }


      .funding p {
        font-size: 24px;
        line-height: 26px;
      }


      .v_icon {
        margin: 0px 0px 0px 6px;
      }

      .confirmation_question {
        margin: 40px 0px 30px 0px;
        font-size: 18px;
        line-height: 22px;
        width: 80%;
        text-align: center;
      }

      .avatars_funding {
        box-sizing:border-box;
        padding: 0px;
/*        @apply(--layout-vertical);
        @apply(--layout-start);
        @apply(--layout-start-justified); */
        margin-bottom: 2vw;
        margin-right: 15px;

      }


      .dealcreate_steps {
        padding: 10px 10px 10px 0px;
      }


      .detail {
        margin-bottom: 4px;
        color: var(--sc-grey3);
        width: 100%;
        @apply(--layout-vertical);
        @apply(--layout-start);
        @apply(--layout-start-justified);

      }


      .cat {
        /*margin-top: 4px;*/
        font-size: 14px;
        font-family: montserratlight;
        color: var(--sc-grey3);
        width: 100%;
        text-align: left;
      }



      .tophalf h1 {
        font-size: 40px;
        line-height: 48px;
        max-width: 100%;
      }

      .avatar_funding p {
        max-width: 100px;
      }
        .approver_inner {
          width: 100%;
          height: 90vh;
          box-sizing:border-box;
          padding: 12vh 12vw 6vh 12vw;
          @apply(--layout-vertical);
          @apply(--layout-start-justified);
          @apply(--layout-center);
        }


      .accepted-container {
        margin-top: -8vh;
      }

      .waiting-msg {
        padding-top: 2vh;
      }

      .cancel-container {
        flex-grow: 1;
        @apply(--layout-vertical);
        @apply(--layout-center);
        @apply(--layout-start-justified);
        padding-top: 6vh;
      }

    }



    </style>
    <!-- D={{requestdata.dealstate}}
    D2={{requestdatadealstate}} -->
    <sc-shh web3="{{shhweb3}}"></sc-shh>
    <sc-listeners id="listeners"></sc-listeners>
    <sc-config id="config" config="{{config}}"></sc-config>
    <sc-helpers id="helpers"></sc-helpers>
    <!-- <sc-hashtagcontract id="hashtagcontract" hashtagcontract="{{data.hashtag}}"  loaded="{{hcready}}"></sc-hashtagcontract> -->
    <iron-media-query query="(min-width:0px) and (max-width: 420px)" query-matches="{{phoneview}}"></iron-media-query>
    <!-- <sc-dealstate deal="{{requestdata}}" dealstate="{{dealstate}}"></sc-dealstate> -->

    <app-route route="{{route}}" pattern="/:hashtag/:requestid/:replyid" data="{{data}}" tail="{{page}}"></app-route>
    <app-route route="{{page}}" pattern="/:page" data="{{pageRouteData}}"></app-route>


        <neon-animated-pages id="seekerpages" attr-for-selected="data-action" selected="{{selecteddealpage}}" entry-animation="{{seekerpagesentry}}" exit-animation="{{seekerpagesexit}}">

          <neon-animatable data-action="dodeal">

            <div class="topbar">
              <span class="flex"></span>
                <paper-icon-button on-tap="leave" icon="sc-icons:decline" noink>back</paper-icon-button>
            </div>

            <div class="totalbox vertic center startjust totalwidth">
              <div class="tophalf totalwidth">

              <div class="dealid" on-tap="showDetails">
                <p class="small light grey2">Dealid {{requestdata.id}}</p>
              </div>

               <template is="dom-if" if="{{_is(requestdatadealstate,'accepted')}}">
                  <h1 class="">You selected <span class="light blue replyer_username">{{replydata.provider.username}}</span> to make a deal for <span class=""><sc-tokenbalanceformatter value="{{deducthalfcommission(requestdata.amount,hashtagcommission)}}" rounding="false" decimals=3 denomination="SWT"></sc-tokenbalanceformatter></span>.</h1>
               </template>

                <template is="dom-if" if="{{_is(requestdatadealstate,'canceled')}}">
                  <h1 class="">You have <span class="bold">canceled</span> this deal.</h1>
                </template>

               <template is="dom-if" if="{{_is(requestdatadealstate,'provideraccepted')}}">
                  <h1 class=""><span class="bold">{{replydata.provider.username}} accepted!</span></h1>
                </template>

               <template is="dom-if" if="{{_is(requestdatadealstate,'indeal')}}">
                  <h1 class=""><span class="bold">You're in deal</span> with <span class="light blue replyer_username">{{replydata.provider.username}}</span>.</h1>
                </template>

             <!--    <template is="dom-if" if="{{_is(requestdatadealstate,'payout')}}">
                  <h1 class=""><span class="bold"></span>You started the payout of this deal (<sc-tokenbalanceformatter value="{{requestdata.amount}}"></sc-tokenbalanceformatter>).</h1>
                </template> -->

                <template is="dom-if" if="{{_is(requestdatadealstate,'payout')}}">

                  <h1 class=""><span class="bold"><sc-tokenbalanceformatter value="{{deducthalfcommission(requestdata.amount,hashtagcommission)}}" decimals=3  denomination="SWT"></sc-tokenbalanceformatter></span> has been paid out to <span class="light blue replyer_username">{{replydata.provider.username}}</span>.</h1>
                </template>


                <div class="details_toggler" on-tap="showDetails">
                  <div class$="triangle {{collapsestate}}">
                    <svg id="triangle_icon" x="0px" y="0px" viewBox="0 0 50 50" fill="#B3B3B3">
                    <polygon points="6.5,4.9 6.5,44.5 42,24.9 "/>
                    </svg>
                  </div>
                  <p class="grey2b">{{dealdetailsmsg}}</p>
                </div>


                <iron-collapse id="details_collapser">
                    <div class="details_collapser_inner">
                      <div class="details_request totalwidth vertic start startjust">

                        <div class="detail">
                          <p class="cat">Offer</p>
                          <p class="reg bold"><sc-tokenbalanceformatter value="{{deducthalfcommission(requestdata.amount,hashtagcommission)}}" decimals=3 denomination="SWT"></sc-tokenbalanceformatter></p>
                        </div>

                        <template is="dom-if" if="{{hashtagcommission}}">
                          <div class="detail">
                            <p class="cat">Fee</p>
                            <p class="reg"><sc-tokenbalanceformatter value="{{halfof(hashtagcommission)}}" decimals=3 denomination="SWT"></sc-tokenbalanceformatter></p></p>
                          </div>
                        </template>

                        <div class="detail">
                          <p class="cat">Hashtag</p>
                          <p class="reg bold">#{{hashtagcontractToName(requestdata.hashtag)}}</p>
                        </div>


                        <div class="detail">
                          <p class="cat">Requester</p>
                          <a href="https://etherscan.io/address/[[requestdata.seeker.pubkey]]" target="_new" class="reg blue">[[requestdata.seeker.username]]</a>
                        </div>

                        <div class="detail">
                          <p class="cat">Provider</p>
                          <a href="https://etherscan.io/address/[[replydata.provider.pubkey]]" target="_new"  class="reg blue">[[replydata.provider.username]]</a>
                        </div>


                        <div class="detail">
                          <p class="cat">Dealid</p>
                          <p class="reg">[[requestdata.id]]</p>
                        </div>
                        <div class="whitespace"></div>

                        <div class="detail">
                          <p class="cat">Initial request</p>
                          <p class="reg">[[requestdata.msg]]</p>
                        </div>

                        <div class="detail">
                          <p class="cat">Selected reply</p>
                          <p class="reg">[[replydata.msg]]</p>
                        </div>
                        <div class="whitespace"></div>

                        <template is="dom-if" if="{{requestdata.creationtx}}">
                          <div class="detail">
                            <p class="cat">Deal creation</p>
                            <a href="https://etherscan.io/tx/{{requestdata.creationtx}}" target="_new"  class="reg blue">{{requestdata.creationtx}}</a>
                          </div>
                        </template>

                        <template is="dom-if" if="{{requestdata.providerfundingtx}}">
                          <div class="detail">
                            <p class="cat">Provider funding</p>
                            <a href="https://etherscan.io/tx/{{requestdata.providerfundingtx}}" target="_new"  class="reg blue">{{requestdata.providerfundingtx}}</a>
                          </div>
                        </template>

                        <template is="dom-if" if="{{requestdata.payouttx}}">
                          <div class="detail">
                            <p class="cat">Payout</p>
                            <a href="https://etherscan.io/tx/{{requestdata.payouttx}}" target="_new"  class="reg blue">{{requestdata.payouttx}}</a>
                          </div>
                        </template>

                        <template is="dom-if" if="{{requestdata.seekercanceltx}}">
                          <div class="detail">
                            <p class="cat">Canceled</p>
                            <a href="https://etherscan.io/tx/{{requestdata.seekercanceltx}}" target="_new"  class="reg blue">{{requestdata.seekercanceltx}}</a>
                          </div>
                        </template>

                      </div>
                    </div>
                </iron-collapse>
                <div class="avatars_funding">
                  <div class="avatar_funding">
                    <sc-avatar
                      ipfshash="[[requestdata.seeker.avatarhash]]"
                      pubkey="[[requestdata.seeker.pubkey]]"
                      id="makedeal_myavatar"
                      size="{{seekeravatarsize}}"
                      on-tap="tempTapto"
                      ></sc-avatar>
                  </div>
                  <div class="avatar_funding">
                    <sc-avatar
                      ipfshash="[[replydata.provider.avatarhash]]"
                      pubkey="[[replydata.provider.pubkey]]"
                      id="makedeal_otheravatar"
                      size="{{provideravatarsize}}"
                      on-tap="tempTap"
                      ></sc-avatar>
                  </div>
                  <template is="dom-if" if="{{_is(requestdatadealstate,'indeal')}}">
                    <div class="chatbtn">
                      <paper-icon-button id="chatbutton" class="chatbtn_iconbtn shadow blue grey4" icon="sc-icons:babble" on-tap="toDealchat"></paper-icon-button>
                    </div>
                  </template>
                </div>


              </div>

              <div class$="bottomhalf {{bottombg}} totalwidth">
                <template is="dom-if" if="{{_is(requestdatadealstate,'accepted')}}">
                  <div class="accepted-container">
                  <template is="dom-if" if="{{!phoneview}}">
                    <sc-loader class="white halfopacity waiting-msg" color="white" small><span class="light">Waiting for {{replydata.provider.username}} to respond</span></sc-loader>
                  </template>
                  <template is="dom-if" if="{{phoneview}}">
                    <div class="totalwidth vertic centercenter waiting-msg halfopacity">
                      <p class="white light">Waiting for {{replydata.provider.username}} to respond</p>
                      <div class="whitespace"></div>
                      <sc-loader class="white" color="white" small></sc-loader>
                    </div>
                  </template>

                  <div class="cancel-container redback">

                    <p class="white light centertxt">Cancel deal with {{replydata.provider.username}}.</p>
                    <template is="dom-if" if="{{phoneview}}"><div class="whitespace"></div></template>
                    <div class="confirmbtns">
                      <paper-icon-button icon="sc-icons:decline" class="white big confirmbtn red shadow" on-tap="cancelDeal"></paper-icon-button>
                    </div>
                  </div>
                  </div>
                </template>
                <!-- <template is="dom-if" if="{{provideraccept}}"> -->
                  <template is="dom-if" if="{{_is(requestdatadealstate,'indeal')}}">
                    <template is="dom-if" if="{{!phoneview}}">
                      <div class="flex"></div>
                    </template>
                    <div class="confirmbtns">
                      <paper-button on-tap="toapproveDeal" class="confirmbtn payoutbtn green white shadow" noink>Payout
                        <iron-icon icon="sc-icons:v" class="medium white"></iron-icon>
                      </paper-button>
                    </div>
                  </template>
                <!-- </template> -->
              </div>
            </div>
            <sc-dealfortwo id="dealfortwo" on-status-update="handle"></sc-dealfortwo>


          </neon-animatable>


          <neon-animatable data-action="dealchat">
            <sc-dealchat
            topic="[[requestdata.id]]"
            hashtag="[[requestdata.hashtag]]"
            active="[[_dealChatSelected(selecteddealpage)]]"
            route="[[route]]"
            on-back="backfromChat">
            </sc-dealchat>
          </neon-animatable>

          <neon-animatable data-action="approvethis">
          <div class="approver greenback">
            <div class="topbar">
              <span class="flex"></span>
              <paper-icon-button on-tap="backfromapproveDeal" icon="sc-icons:decline" noink class="white">back</paper-icon-button>
            </div>
            <div class="approver_inner">
              <h1 class="light white centertxt">Do you want to payout <span class="bold"><sc-tokenbalanceformatter value="{{deducthalfcommission(requestdata.amount,hashtagcommission)}}" decimals=3  denomination="SWT"></sc-tokenbalanceformatter></span> to <span class="bold">{{replydata.provider.username}}</span>?</h1>
            <div class="fivespace"></div>
            <div class="whitespace"></div>
              <div class="approver_confirmbtns">
                <iron-icon icon="sc-icons:decline" class="decliner medium white" on-tap="backfromapproveDeal"></iron-icon>
                <template is="dom-if" if="{{!payoutinitiated}}">
                <paper-icon-button icon="sc-icons:v" noink class="confirmbtn green big white shadow" on-tap="approveDeal"></paper-icon-button>
                </template>
                <template is="dom-if" if="{{payoutinitiated}}">
                  <!-- waiting icon -->
                  <sc-loader small color="white"></sc-loader>

                </template>
              </div>
            </div>
          </div>
          </neon-animatable>
        </neon-animated-pages>
  </template>

  <script>

    Polymer({

      is: 'sc-dealfortwo-seeker',

      behaviors: [
        Polymer.NeonSharedElementAnimatableBehavior,
        Polymer.NeonAnimationRunnerBehavior,
        ReduxBehavior
      ],

      observers: [
        '_shhweb3(shhweb3)',
        '_checksize(phoneview)',
        '_hashtag(data.hashtag)',
        '_data(data)',
        '_log(replydata)',
//        '_hashtagcontractloaded(hcready)',
        '_hashtaginfo(requestdata,hashtaginfo)'
      ],


      properties: {
        identity: {
          type: Object,
          statePath: 'identity',
        },

        hashtaginfo: {
          type: Object,
          statePath: 'hashtaginfo',
        },

        web3: {
          type: Object,
          observer: '_web3'
        },
        route: {
          type: Object,
          observer: '_route'
        },
        pageRouteData: {
            type: Object,
            observer: '_pageRoute',
        },
        deals: {
          type: Array,
          statePath: 'deals',
          observer: '_getdata'
        },
        bottombg: {
          type: String,
          value: 'blueback'
        },
      },

      _hashtaginfo: function(){
        // fetch this deal's commission
        if (this.requestdata.dealdata && this.requestdata.dealdata.commissionValue){
          this.hashtagcommission = this.requestdata.dealdata.commissionValue;
          return;
        }
        // fallback to hashtag commission
        if (this.requestdata && this.requestdata.hashtag && this.hashtaginfo){
          this.hashtagcommission = this.hashtaginfo[this.requestdata.hashtag].commission;
        }
      },


      halfof: function(val){
        return val/2;
      },

      deducthalfcommission: function(v,w){
        return v-w/2;
      },

      hashtagcontractToName: function(a){
        return this.$.config.hashtagcontractToName(a);
      },

      ready: function(){
        this.selecteddealpage = 'dodeal';
        this.dealdetailsmsg = "Show details";
      },


      // _hashtagcontractloaded: function(){
      //   var self = this;
      //   this.$.hashtagcontract.getCommission(function(err,res){
      //     self.hashtagcommission = res;
      //     self.hashtagcommission_div2 = self.hashtagcommission / 2;
      //   });
      // },

      _route: function(){
        this._hashtag();
      },

      _pageRoute: function() {
        switch (this.pageRouteData.page) {
          case 'dealchat':
            this.selecteddealpage = 'dealchat';
        }
      },

      _hashtag: function(){
      },

      _data: function(){
        this.requestid = this.data.requestid;
        this.replyid = this.data.replyid;
        this._getdata();
        console.log("joooo uit deal42seeker", this.data);
      },

      _getdata: function(){
        this.payoutinitiated = false;

        var self = this;
        if (!this.deals || !this.requestid || !this.replyid){
          return;
        }
        var request = this.deals.find(function(item){
            return item.id === self.requestid;
        });

        if (request){
          this.requestdata = request;
          this.requestdatadealstate = request.dealstate;

          if (this.requestdatadealstate == 'indeal' || this.requestdatadealstate === 'payout'){
            this.bottombg = 'greenback';
          } else if (this.requestdatadealstate == 'canceled') {
            this.bottombg = 'redback';
          }else {
              this.bottombg = 'blueback';
            }
          }


        if (request && request.replies){
          var reply = request.replies.find(function(item){
            return item.id === self.replyid;
          });
          this.replydata = reply;
        }
      },

      /**
      * 'onEnter' are the behaviors that occur when the router tells this component enters the stage
      * use this to initialize any variables to start the component
      */
      onEnter: function(){
      },

      /**
      * 'onExit' are the behaviors that occur when the router tells this component to leave the stage
      * use this to reset any variables when leaving this component while it remains loaded.
      */
      onExit: function(){
      },

      /**
      * 'leave' fires the 'leave' to the parent-element. (This also contains animation-config for going back to sc-home.)
      */
      leave: function(){
        this.fire('redirect', {
          target: '/hashtag/' + this.requestdata.hashtag + '/list'
        });
      },


      _checksize: function(){
        // console.log('Jooooooooo phoneview?', this.phoneview);
        if (this.phoneview) {
          this.avatarsize = "medium";
          this.seekeravatarsize = "medium";
          this.provideravatarsize = "medium";
          this.vsize = "medium";
          this.sendbtnsize = "";
        } else {
          this.avatarsize = "medium";
          this.seekeravatarsize = "more";
          this.provideravatarsize = "more";
          this.sendbtnsize = "bigbtn";
          this.vsize = "medium";
        }
      },


      /**
      * '_is', a function to bind a template to a certain value of a variable.
      */
      _is: function(a, b) {
        if (b === undefined){
          b = true;
        }
        //console.log(a ,'(',typeof a,') is',b,'(',typeof b,') they are equal for ==',a == b,', they are equal for ===',a === b);
        return a === b;
      },

      createDeal: function(){

        this.selecteddealpage = 'waiting';
        this.myamount_state = 'amountconfirmed';
      },

      // _connectionline: function(){
      //   if(this.myamount_state=='amountconfirmed' && this.otheramount_state=='amountconfirmed') {

      //   } else {

      //   }
      // },


      toPayout: function(){
        this.selecteddealpage = 'payout';
      },

      dummyClick: function(){
        this.otheramount_state = 'amountconfirmed';
        this.selecteddealpage = 'dealchat';

      },


      _web3: function() {
        //this.startDeal();
      },



      _shhweb3: function() {
        if (!this.shhweb3) {
          throw new Error('shhweb3 not set while requesting whisper listener');
        }
      },


      showDetails: function(){
        var details = this.$.details_collapser;
        details.toggle();
        if (details.opened){
          this.dealdetailsmsg = "Hide details";
          this.collapsestate = 'opened';
        } else {
          this.dealdetailsmsg = "Show details";
          this.collapsestate = '';
        }
      },


      showSteps: function(){
        var steps = this.$.steps_collapser;
        steps.toggle();

        if (steps.opened){
          this.collapsestate = 'opened';
        } else {
          this.collapsestate = '';
        }
      },


      toDodeal: function(){
        this.selecteddealpage = 'dodeal';
      },




      toapproveDeal: function(){
        this.seekerpagesentry = 'slide-from-right-animation';
        this.seekerpagesexit = 'slide-left-animation';
        this.selecteddealpage = 'approvethis';
      },

      backfromapproveDeal: function(){
        this.seekerpagesentry = 'slide-from-left-animation';
        this.seekerpagesexit = 'slide-right-animation';
        this.selecteddealpage = 'dodeal';
      },



      approveDeal: function() {

        var self = this;
        self.payoutinitiated = true;

        this.$.dealfortwo.payout(self.requestdata.id,self.identity.pubkey, function(err, payoutTx) {

          var message = {
            type: 'dealfortwo-approve',
            requestid: self.requestdata.id,
            transactionhash: payoutTx,
            timestamp: Date.now(),
          };

          var topics = [
            self.shhweb3.encodetopic('swarmcity-v1'),
            self.shhweb3.encodetopic(message.type),
            self.shhweb3.encodetopic(self.requestdata.hashtag),
            self.shhweb3.encodetopic(self.requestdata.id),
            self.shhweb3.encodetopic('all'),
            self.shhweb3.encodetopic('all'),
            self.shhweb3.encodetopic('all'),
            self.shhweb3.encodetopic('all'),
          ];

          var options = {
            "from": self.shhweb3.identity,
            "topics": topics,
            "payload": self.shhweb3.fromAscii(JSON.stringify(message)),
            "ttl": self.config.sshttl,
            "priority": 1000
          };

          console.log('posting to topics', topics);

          self.shhweb3.shh.post(options, function(err, res) {
            if (!err) {
              console.log('approveDeal -> Reply posted');
            } else {
              console.log('approveDeal -> whisper error:', err);
            }
            // TODO : We assume that this does not error.
            // handle error here ( in UI )

            self.seekerpagesentry = 'slide-from-left-animation';
            self.seekerpagesexit = 'slide-right-animation';
            self.selecteddealpage = 'dodeal';

          });
        });




      },

      cancelDeal: function() {
        var self = this;
//        self.cancelinitiated = true;

        this.$.dealfortwo.cancelDeal(self.requestdata.id, self.identity.pubkey, function(err, cancelTx) {

          if (err) {
            console.log('cancelDeal -> dealfortwo error:', err);
            return;
          }

          var message = {
            type: 'dealfortwo-cancel',
            requestid: self.requestdata.id,
            transactionhash: cancelTx,
            timestamp: Date.now(),
          };

          var topics = [
            self.shhweb3.encodetopic('swarmcity-v1'),
            self.shhweb3.encodetopic(message.type),
            self.shhweb3.encodetopic(self.requestdata.hashtag),
            self.shhweb3.encodetopic(self.requestdata.id),
            self.shhweb3.encodetopic('all'),
            self.shhweb3.encodetopic('all'),
            self.shhweb3.encodetopic('all'),
            self.shhweb3.encodetopic('all'),
          ];

          var options = {
            "from": self.shhweb3.identity,
            "topics": topics,
            "payload": self.shhweb3.fromAscii(JSON.stringify(message)),
            "ttl": self.config.sshttl,
            "priority": 1000
          };

          console.log('posting to topics', topics);

          self.shhweb3.shh.post(options, function(err, res) {
            if (!err) {
              console.log('cancelDeal -> Reply posted');
            } else {
              console.log('cancelDeal -> whisper error:', err);
            }

            self.leave();

          });
        });

      },


      _log: function(target){
        console.log("***** log in deal42seeker ==",target);
      },

      _provideraccepted: function(){
        if (this.provideraccept){
          this.providerfundclass = "fund_accepted";
        } else {
          this.providerfundclass = "fund_init";
        }
      },


      // TEMP FUNCTION: to be removed
      tempTap: function(){
        this.provideraccept = !this.provideraccept;
      },


      // TEMP FUNCTION: to be removed
      tempTapto: function(){
       //this.seekeraccept = !this.seekeraccept;
      },


      tempTapthree: function(){
        this.assignmined = true;
      },

      tempTapfour: function(){
        this.providerfundingmined = true;
      },



      _requestdata: function(){

        // // assigntx check
        // if(this.requestdata.assigntx) {
        //   this.seekeraccept = true;
        // }

        // providerfundingtx check
        // if(this.requestdata.providerfundingtx) {
        //   //debugger;
        //   this.provideraccept = true;
        // }

        // if(this.requestdata.dealstate == 'indeal'){
        //   this.$.chatbutton.enabled = true;
        // }else{
        //   this.$.chatbutton.enabled = false;
        // }

        // if(this.requestdata.providerfundingtx_mined) {
        //   debugger;
        //   this.indeal = true;
        //   this.bottombg = 'greenback';
        // } else {
        //   this.bottombg = 'blueback';
        //   this.indeal = false;
        // }
      },
      /**
      * '_is', a function to bind a template to a certain value of a variable.
      */
      _is: function(a, b) {
        if (b === undefined){
          b = true;
        }
        return a === b;
      },

      toDealchat: function(){
        this.seekerpagesentry = 'slide-from-right-animation';
        this.seekerpagesexit = 'slide-left-animation';
        this.selecteddealpage = 'dealchat';
      },

      backfromChat: function(){
        this.seekerpagesentry = 'slide-from-left-animation';
        this.seekerpagesexit = 'slide-right-animation';
        this.selecteddealpage = 'dodeal';
      },

      _dealChatSelected: function(selectedPage) {
        return selectedPage == 'dealchat';
      },

      // _dealstate: function(){
      //   console.log("dit is deellzz88",this.dealstate);
      // },



    });
  </script>
</dom-module>
