<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../sc-config/sc-config.html">
<link rel="import" href="../sc-web3/sc-web3.html">
<link rel="import" href="../sc-minime/sc-minime.html">
<script type="text/javascript" src="../../bower_components/uuid-js/lib/uuid.js"></script>

<dom-module id="sc-dealfortwo">
  <template>
    <sc-web3 web3="{{web3}}"></sc-web3>
    <sc-config config="{{config}}"></sc-config>
    <sc-minime id="minime"></sc-minime>

  </template>
  <!-- Creates the element's prototype and registers it -->
  <script>
    Polymer({
      is: 'sc-dealfortwo',
      properties: {
        abi: {
          type: Object,
          value: [{
            "constant": false,
            "inputs": [{
              "name": "_dealid",
              "type": "string"
            }, {
              "name": "_dealowner",
              "type": "address"
            }],
            "name": "fundDeal",
            "outputs": [],
            "payable": false,
            "type": "function"
          }, {
            "constant": false,
            "inputs": [{
              "name": "_dealid",
              "type": "string"
            }],
            "name": "payout",
            "outputs": [],
            "payable": false,
            "type": "function"
          }, {
            "constant": false,
            "inputs": [{
              "name": "_dealid",
              "type": "string"
            }, {
              "name": "_dealowner",
              "type": "address"
            }, {
              "name": "_seekerFraction",
              "type": "uint256"
            }],
            "name": "resolve",
            "outputs": [],
            "payable": false,
            "type": "function"
          }, {
            "constant": false,
            "inputs": [{
              "name": "_dealid",
              "type": "string"
            }, {
              "name": "_dealowner",
              "type": "address"
            }],
            "name": "readDeal",
            "outputs": [{
              "name": "status",
              "type": "uint8"
            }, {
              "name": "commissionValue",
              "type": "uint256"
            }, {
              "name": "dealValue",
              "type": "uint256"
            }, {
              "name": "provider",
              "type": "address"
            }],
            "payable": false,
            "type": "function"
          }, {
            "constant": false,
            "inputs": [{
              "name": "_dealid",
              "type": "string"
            }, {
              "name": "_offerValue",
              "type": "uint256"
            }],
            "name": "makeDealForTwo",
            "outputs": [],
            "payable": false,
            "type": "function"
          }, {
            "constant": false,
            "inputs": [{
              "name": "_dealid",
              "type": "string"
            }, {
              "name": "_dealowner",
              "type": "address"
            }],
            "name": "dispute",
            "outputs": [],
            "payable": false,
            "type": "function"
          }, {
            "constant": false,
            "inputs": [{
              "name": "_dealid",
              "type": "string"
            }],
            "name": "cancelDeal",
            "outputs": [],
            "payable": false,
            "type": "function"
          }, {
            "inputs": [{
              "name": "_hashtag",
              "type": "address"
            }],
            "payable": false,
            "type": "constructor"
          }, {
            "anonymous": false,
            "inputs": [{
              "indexed": false,
              "name": "dealForTwoAddress",
              "type": "address"
            }],
            "name": "NewDealForTwo",
            "type": "event"
          }]
        }
      },

      observers: [
        '_getready(web3,config)',
      ],

      _getready: function(){
        if (!this.web3 || !this.config){
          return;
        }
        var DealForTwoFactoryContract = this.web3.eth.contract(this.abi);
        this.DealForTwoFactoryContractInstance = DealForTwoFactoryContract.at(this.config.dealfortwofactory);
      },

      // starts making a dealfortwo. callback with TXhash.
      makeDealForTwo: function(dealID, from, offerAmount, cb) {
        var self = this;
        var extratx = {};
        this.$.minime.checkOrGiveAllowance(from, this.config.dealfortwofactory, offerAmount, function(err, tx) {
          if (err){
            //debugger;
            console.log('giving allowance failed',err);
            return cb(err);
          }
          extratx.allowancetx = tx;
          self.web3.cached.getGasPrice(function(err, gasPrice) {
            if (err){
              console.log('getGasPrice failed',err);
              return cb(err);
            }
            self.DealForTwoFactoryContractInstance.makeDealForTwo.estimateGas(dealID, offerAmount, {
                  from: from
                }, function(err, gasNeeded) {
              // if (err){
              //   debugger;
              //   return cb(err);
              // }
              // If the allowance is not OK yet - gas extimation will not work
              // so use a safe value.
              gasNeeded = gasNeeded || 175000;

              self.DealForTwoFactoryContractInstance.makeDealForTwo.sendTransaction(dealID, offerAmount, {
                from: from,
                gasPrice: gasPrice,
                gas: gasNeeded
              }, function(err, makeDealForTwoTx) {
                if (err) {
                    return cb(err);
                }
                cb(null, makeDealForTwoTx,extratx);
                console.log(err, makeDealForTwoTx);
              });
            });
          });
        });
      },

      fundDeal: function(dealID, dealOwner, offerAmount, from, cb) {
        var self = this;
        var extratx = {};
        this.$.minime.checkOrGiveAllowance(from, this.config.dealfortwofactory, offerAmount, function(err, tx) {
          if (err) {
            debugger;
            return cb(err);
          }
          extratx.allowancetx = tx;
          self.web3.cached.getGasPrice(function(err, gasPrice) {
            self.DealForTwoFactoryContractInstance.fundDeal.estimateGas(dealID, dealOwner, function(err, gasNeeded) {
              gasNeeded = gasNeeded || 175000;
              self.DealForTwoFactoryContractInstance.fundDeal.sendTransaction(dealID, dealOwner, {
                from: from, //self.identity.pubkey,
                gasPrice: gasPrice,
                gas: gasNeeded
              }, function(err, result) {
                if (err) {
                  if (cb) {
                    return cb(err);
                  }
                }
                cb(null, result, extratx);
                console.log(err, result);
              });
            });
          });
        });
      },

      payout: function(dealID, from, cb) {
        var self = this;
        self.web3.cached.getGasPrice(function(err, gasPrice) {
          self.DealForTwoFactoryContractInstance.payout.estimateGas(dealID, {
            from: from
          }, function(err, gasNeeded) {
            if (gasNeeded) {
              gasNeeded = Math.floor(gasNeeded * 1.2);
            } else {
              gasNeeded = 600000;
            }
            self.DealForTwoFactoryContractInstance.payout.sendTransaction(dealID, {
              from: from,
              gasPrice: gasPrice,
              gas: gasNeeded
            }, function(err, result) {
              if (err) {
                if (cb) {
                  return cb(err);
                }
              }
              cb(null, result);
              console.log(err, result);
            });
          });
        });
      },

      readDeal: function(dealId, dealOwner, cb) {
        var self = this;
        self.DealForTwoFactoryContractInstance.readDeal.call(dealId, dealOwner, function(err, result) {

          cb(null, {
            status: result[0].toNumber(10),
            commissionValue: result[1].toNumber(10),
            dealValue: result[2].toNumber(10),
            provider: result[3]
          });
        });
      },

      cancelDeal: function(dealId, from, cb) {
        var self = this;
        self.web3.cached.getGasPrice(function(err, gasPrice) {
          self.DealForTwoFactoryContractInstance.cancelDeal.estimateGas(dealId, {
            from: from
          }, function(err, gasNeeded) {
            if (gasNeeded) {
              gasNeeded = Math.floor(gasNeeded * 1.2);
            } else {
              gasNeeded = 75000;
            }
            self.DealForTwoFactoryContractInstance.cancelDeal.sendTransaction(dealId, {
              from: from,
              gasPrice: gasPrice,
              gas: gasNeeded
            }, function(err, result) {
              if (err) {
                if (cb) {
                  return cb(err);
                }
              }
              cb(null, result);
              console.log(err, result);
            });
          });
        });
      },

      getDeals: function(pubkey) {
        debugger;
        sig = EthJS.Util.rlphash('makeDealForTwo(string,uint)');
        //                  var msgHash = EthJS.Util.rlphash('this is the message');

        var c = "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef";;

        var filter = this.web3.eth.filter({
          //address: pubkey,
          fromBlock: 3885031,
          toBlock: 3885031
        });

        filter.get(function(error, logs) {
          var foundDeal = logs.find(function(item) {
            return item.transactionHash === '0xea31682fe5a3e0c9cadbe5704545709cbe76acbb4d9e1c985e6940a9b583550b';
          });


          debugger;
          console.log('ikke', logs);
        });

      },

    });
  </script>
</dom-module>
