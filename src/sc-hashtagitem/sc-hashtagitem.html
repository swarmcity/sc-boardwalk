<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/iron-media-query/iron-media-query.html">

<link rel="import" href="../../bower_components/moment-js/moment-js.html">

<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">

<link rel="import" href="../../bower_components/sc-style/sc-style.html">
<link rel="import" href="../../bower_components/sc-iconset/sc-iconset.html">

<link rel="import" href="../sc-avatar/sc-avatar.html">
<link rel="import" href="../sc-hashtagcontract/sc-hashtagrep.html">
<link rel="import" href="../sc-dealstate/sc-dealstate.html">


<!--
`sc-hashtagitem`

This components is the representation of a request in the requests-list on sc-hashtag.

@demo src/sc-hashtagitem/demo/index.html
-->

<dom-module id="sc-hashtagitem">
  <template>
    <style include="sc-styles">
      :host {
        display: block;
        width: 100%;
        --my-totalbg-color: rgba(255,255,255,0.25);
        background-color: var(--my-totalbg-color);
      }


      .totalcontainer {
/*        @apply(--base-shadow); */

      }

      .itemtotal {
        width: 100%;
        box-sizing:border-box;
        padding: 25px 25px 0px 25px;
      }


      .smalltxt {
        font-size: 14px;
        line-height: 16px;
      }

      .whodidthis {
        margin-right: 16px;
      }

      .categorie {
        box-sizing:border-box;
        padding: 4px 4px 4px 4px;
        font-size: 14px;
        line-height: 16px;
      }

/*      .offertime {

      }*/


      .margtop {
        margin-top: 6px;
      }

      .margbot {
       margin-bottom: 6px;
      }

      .linehi {
        line-height: 22px;
      }

      .timestamp {
        margin: 0px 4px 6px 0px;
      }

      .replyitem {
        box-sizing:border-box;
        margin-top: 10px;
      }



      sc-avatar {
        margin-right: 10px;
      }

      .provavatar {
        margin-right: 15px;
      }

      .myavatar {
/*        width: 22px;
        height: 22px;
*/      }

      .othermargins {
        margin-right: 5px;
      }


      .seeker {
        margin-right: 12px;
        /*border-bottom: 1px dotted var(--sc-blue);*/
      }
      .seekerrep {
        margin-right: 10px;
        margin-left: 2px;
      }

      .msg {
        margin-top: 4px;
        font-size: 16px;
        line-height: 20px;
          /*margin: 5px 0px 15px 0px;*/
      }

      .hashtagdealmsg {
        margin-bottom: 4px;
        font-size: 16px;
        line-height: 20px;
      }

      .offeramount {
          font-size: 30px;
          line-height: 30px;
      }

      .offeramountSWT {
          font-size: 15px;
          line-height: 15px;
      }

      .nrofreplies {
        box-sizing:border-box;
        margin: 2px 0px 10px 0px;
      }

      .nrofreplies iron-icon {
        width: 17px;
        height: 13px;
        margin-bottom: 2px;
      }

      .half {
        opacity: 0.75;
      }

      .full {
        opacity: 1;
      }

      iron-icon.verysmall {
        width: 14px;
        height: 14px;
        margin-left: 3px;
      }

      .divider {
        margin-right: 8px;
        margin-left: 8px;
      }

      .youreplied {
        /*margin-top: 26px;*/
        box-sizing: border-box;
        padding: 20px 25px;
        border-bottom: 1px solid var(--sc-grey2);
        background-color: rgba(255, 255, 255, 0.15);
      }


      .youreplied p {
        font-size: 14px;
        line-height: 18px;
      }

      .youreplied small {
        font-size: 12px;
        line-height: 14px;
      }

      .yourselected {
        box-sizing: border-box;
        padding: 20px 25px;
        border-bottom: 1px solid var(--sc-grey2);
        background-color: rgba(255, 255, 255, 0.15);
      }

      .amountstuff {
        min-height: 42px;
        height: 100%;
        @apply(--layout-self-end);
        box-sizing:border-box;
        padding-left: 10px;
        padding-bottom: 0px;
      }


      .grey2b {
        color: #999999;
      }

      .lid {
        height: 25px;

      }

      .dealmessage {
          padding-left: 75px;
      }

      .dealmessagechosen {
          padding-left: 75px;
      }

      .dealmessage p {
        padding-top: 6px;
      }


      .dottedline {
        width: 100%;
        height: 1px;
        border-top: 1px dotted rgba(0,0,0,0.075);
      }

      .you {
/*        box-sizing:border-box;
        padding: 2px 4px;*/
        margin-right: 12px;

      }

      .request_info {
        width: 100%;
        @apply(--layout-horizontal);
        @apply(--layout-center);
        @apply(--layout-start-justified);
        @apply(--layout-wrap);
      }

      .replycount_box {
/*        margin-right: 10px;*/
        @apply(--layout-self-end);
      }
      .replycount_box iron-icon {
        margin-left: 3px;
        margin-bottom: 3px;
      }

/*      .blueborder {
        border-left: 2px solid var(--sc-blue);
      }

      .whiteborder {
        border-left: 2px solid transparent;
      }*/

      @media all and (min-width: 0) and (max-width: 420px) {
        .totalcontainer {
          box-shadow: none;
          -webkit-box-shadow: none;
          -moz-box-shadow: none;
          -o-box-shadow: none;
        }
        .smalltxt {
          font-size: 13px;
          line-height: 17px;
        }

        .amountstuff {
          padding-bottom: 2px;
        }

        .dealmessage p {
          padding-top: 12px;
        }

        .request_info {
          width: 100%;
          @apply(--layout-vertical);
          @apply(--layout-start);
          @apply(--layout-start-justified);
        }


      }

    </style>

    <sc-dealstate deal="{{item}}" dealstate="{{dealstate}}"></sc-dealstate>
    <iron-media-query query="(min-width:0px) and (max-width: 540px)" query-matches="{{phoneview}}"></iron-media-query>


      <!-- WHEN REPLY == NOT SELECTED YET -->
      <template is="dom-if" if="{{!item.selectedreply}}">
        <div class$="totalcontainer totalwidth vertic start centerjust {{ownerclass}}">

          <div class="itemtotal horizont start startjust" on-tap="toggleItem">
            <sc-avatar
              ipfshash="[[item.seeker.avatarhash]]"
              size="small">
            </sc-avatar>
            <div class="flex vertic start startjust">
              <div class="request_info">
              <template is="dom-if" if="{{youareowner(item.seeker.pubkey)}}">
                <p class="you small bold grey4">you • <span class="bold"><sc-hashtagrep pubkey="{{item.seeker.pubkey}}" hashtagname="{{item.hashtag}}"></sc-hashtagrep></span></p>
              </template>
              <template is="dom-if" if="{{!youareowner(item.seeker.pubkey)}}">
                <p class="seeker small reg blue">{{item.seeker.username}} • <span class="bold"><sc-hashtagrep pubkey="{{item.seeker.pubkey}}" hashtagname="{{item.hashtag}}"></sc-hashtagrep></span></p>
              </template>

              <template is="dom-if" if="{{phoneview}}">
                <div class="totalwidth horizont center startjust">
                <p class="grey2b light small"><moment-js date="{{item.offertime}}" format="HH:mm:ss.SSS" from-now></moment-js></p>
                <template is="dom-if" if="{{itemreplies}}">
                  <div class="replies horizont centercenter">
                    <p class="divider small grey2b light">|</p>
                    <small class="small grey2b light">{{itemreplies.length}}</small>
                    <iron-icon icon="sc-icons:babble" class="grey2b verysmall">replies</iron-icon>
                  </div>
                </template>
                </div>
              </template>
              <template is="dom-if" if="{{!phoneview}}">
                <p class="grey2b light small"><moment-js date="{{item.offertime}}" format="HH:mm:ss.SSS" from-now></moment-js></p>
                <template is="dom-if" if="{{itemreplies}}">
                  <div class="replies horizont centercenter">
                    <p class="divider small grey2b light">|</p>
                    <small class="small grey2b light">{{itemreplies.length}}</small>
                    <iron-icon icon="sc-icons:babble" class="grey2b verysmall">replies</iron-icon>
                  </div>
                </template>
              </template>


              </div>
              <p class="msg totalwidth grey4">{{item.msg}}</p>
            </div>
            <template is="dom-if" if="{{!phoneview}}">
            <template is="dom-if" if="{{youareowner(item.seeker.pubkey)}}">
              <div class="replycount_box horizont center endjust">
                <p class="bold">{{item.replies.length}}</p>
                <iron-icon icon="sc-icons:babble" class="small replyicon">replies</iron-icon>
              </div>
            </template>
            </template>

            <div class="amountstuff vertic end endjust">
              <small class="bold yellow">for</small>
              <p class="bold yellow"><sc-tokenbalanceformatter value="{{item.amount}}"></sc-tokenbalanceformatter></p>
            </div>


          </div>


          <template is="dom-if" if="{{showdealmsg}}">
            <div class="dealmessage totalwidth horizontal center endjust">
              <p class$="small {{dealmessageclass}} bold">{{dealmessage}}</p>
            </div>
          </template>

          <iron-collapse id="repliescollapser" class="totalwidth">
            <template is="dom-if" if="{{!phoneview}}">
              <div class="whitespace"></div>
            </template>
            <template is="dom-if" if="{{!youareowner(item.seeker.pubkey)}}">
              <template is="dom-if" if="{{!item.ireplied}}">
                  <sc-itemreplier itemdata="{{item}}">
                  </sc-itemreplier>
              </template>
            </template>
            <template is="dom-repeat" as="currentreply" items="{{itemreplies}}">
              <sc-itemreply
              item="{{item}}"
              btnshow="{{youareowner(item.seeker.pubkey)}}"
              reply="{{currentreply}}"
             >
              </sc-itemreply>
            </template>
          </iron-collapse>

          <div class="lid totalwidth"></div>
        </div>
      </template>


      <!-- WHEN REPLY == SELECTED -->
      <template is="dom-if" if="{{item.selectedreply}}">

        <!-- U R NOOOT seeker -->
        <template is="dom-if" if="{{!youareowner(item.seeker.pubkey)}}">

          <div class$="totalwidth vertic start centerjust {{ownerclass}}">
              <div class="itemtotal horizont start startjust" on-tap="toggleItem">
                <sc-avatar
                  ipfshash="[[item.seeker.avatarhash]]"
                  size="small">
                </sc-avatar>

                <!-- Created. -->
                <template is="dom-if" if="{{_is(dealstate,'created')}}">
                  <div class="flex vertic start startjust">
                    <div class="request_info">
                      <p class="seeker small reg blue">{{item.seeker.username}} • <span class="bold"><sc-hashtagrep pubkey="{{item.seeker.pubkey}}" hashtagname="{{item.hashtag}}"></sc-hashtagrep></span></p>
                      <template is="dom-if" if="{{phoneview}}">
                        <div class="totalwidth horizont center startjust">
                        <p class="grey2b light small"><moment-js date="{{item.offertime}}" format="HH:mm:ss.SSS" from-now></moment-js></p>
                        <template is="dom-if" if="{{itemreplies}}">
                          <div class="replies horizont centercenter">
                            <p class="divider small grey2b light">|</p>
                            <small class="small grey2b light">{{itemreplies.length}}</small>
                            <iron-icon icon="sc-icons:babble" class="grey2b verysmall">replies</iron-icon>
                          </div>
                        </template>
                        </div>
                      </template>
                      <template is="dom-if" if="{{!phoneview}}">
                        <p class="grey2b light small"><moment-js date="{{item.offertime}}" format="HH:mm:ss.SSS" from-now></moment-js></p>
                        <template is="dom-if" if="{{itemreplies}}">
                          <div class="replies horizont centercenter">
                            <p class="divider small grey2b light">|</p>
                            <small class="small grey2b light">{{itemreplies.length}}</small>
                            <iron-icon icon="sc-icons:babble" class="grey2b verysmall">replies</iron-icon>
                          </div>
                        </template>
                      </template>
                    </div>
                    <p class="msg totalwidth grey4">{{item.msg}}</p>
                  </div>
                  <div class="amountstuff vertic end endjust">
                    <small class="bold yellow">for</small>
                    <p class="bold yellow"><sc-tokenbalanceformatter value="{{item.amount}}"></sc-tokenbalanceformatter></p>
                  </div>
                </template>

                <!-- Provider accepted. -->
                <template is="dom-if" if="{{_is(dealstate,'provideraccepted')}}">
                  <!-- U R provider -->
                  <template is="dom-if" if="{{youareowner(currentprovider.pubkey)}}">
                    <sc-avatar
                      ipfshash="[[currentprovider.avatarhash]]"
                      size="small">
                    </sc-avatar>
                  </template>

                  <div class="flex vertic start startjust">
                    <div class="request_info">
                      <p class="seeker small reg blue">{{item.seeker.username}} • <span class="bold"><sc-hashtagrep pubkey="{{item.seeker.pubkey}}" hashtagname="{{item.hashtag}}"></sc-hashtagrep></span></p>
                      <template is="dom-if" if="{{phoneview}}">
                        <div class="totalwidth horizont center startjust">
                        <p class="grey2b light small"><moment-js date="{{item.offertime}}" format="HH:mm:ss.SSS" from-now></moment-js></p>
                        <template is="dom-if" if="{{itemreplies}}">
                          <div class="replies horizont centercenter">
                            <p class="divider small grey2b light">|</p>
                            <small class="small grey2b light">{{itemreplies.length}}</small>
                            <iron-icon icon="sc-icons:babble" class="grey2b verysmall">replies</iron-icon>
                          </div>
                        </template>
                        </div>
                      </template>
                      <template is="dom-if" if="{{!phoneview}}">
                        <p class="grey2b light small"><moment-js date="{{item.offertime}}" format="HH:mm:ss.SSS" from-now></moment-js></p>
                        <template is="dom-if" if="{{itemreplies}}">
                          <div class="replies horizont centercenter">
                            <p class="divider small grey2b light">|</p>
                            <small class="small grey2b light">{{itemreplies.length}}</small>
                            <iron-icon icon="sc-icons:babble" class="grey2b verysmall">replies</iron-icon>
                          </div>
                        </template>
                      </template>
                    </div>
                    <p class="msg totalwidth grey4">{{item.msg}}</p>
                  </div>
                </template>

                <!-- In deal. -->
                <template is="dom-if" if="{{_is(dealstate,'indeal')}}">
                  <!-- U R provider -->
                  <template is="dom-if" if="{{youareowner(currentprovider.pubkey)}}">
                    <sc-avatar
                      ipfshash="[[currentprovider.avatarhash]]"
                      size="small">
                    </sc-avatar>
                  </template>

                  <div class="flex vertic start startjust">
                    <template is="dom-if" if="{{!phoneview}}">
                      <p class="hashtagdealmsg totalwidth grey4"><span class="bold">You're in deal</span> with {{item.seeker.username}}.</p>
                      <p class="small totalwidth grey2">Waiting for {{item.seeker.username}} to initiate payout.</p>
                    </template>
                    <template is="dom-if" if="{{phoneview}}">
                      <p class="hashtagdealmsg totalwidth grey4"><span class="bold">In deal</span> with {{item.seeker.username}}.</p>
                      <p class="small totalwidth grey2">Waiting for payout.</p>
                    </template>
                  </div>

                  <div class="amountstuff vertic end endjust">
                    <small class="bold green">for</small>
                    <p class="bold green"><sc-tokenbalanceformatter value="{{item.amount}}"></sc-tokenbalanceformatter></p>
                  </div>

                </template>

              </div>


              <template is="dom-if" if="{{_is(dealstate,'created')}}">
                <div class="dealmessage totalwidth horizontal center endjust">
                  <p class$="small {{dealmessageclass}} bold">{{dealmessage}}</p>
                </div>
                <iron-collapse id="repliescollapser" class="totalwidth">
                  <div class="dealmessagechosen totalwidth horizontal center endjust">
                    <p class="small grey3 reg">{{dealmessagechosen}}</p>
                  </div>
                </iron-collapse>
              </template>


            <div class="lid totalwidth"></div>
          </div>
        </template>


        <!-- U R seeker -->
        <template is="dom-if" if="{{youareowner(item.seeker.pubkey)}}">
          <div class$="totalwidth vertic start centerjust {{ownerclass}} whiteback" on-tap="toDealForTwoSeeker">
              <div class="itemtotal horizont start startjust" on-tap="">
                <sc-avatar
                  ipfshash="[[item.seeker.avatarhash]]"
                  size="small">
                </sc-avatar>
                <sc-avatar
                  ipfshash="[[currentprovider.avatarhash]]"
                  size="small"
                  class="provavatar">
                </sc-avatar>


                  <!-- Created. -->
                  <template is="dom-if" if="{{_is(dealstate,'created')}}">
                    <div class="flex vertic start startjust">
                       <p class="hashtagdealmsg totalwidth grey4">You selected {{currentprovider.username}} to make a deal with.</p>
                       <p class="small totalwidth grey2b">Waiting for {{currentprovider.username}} to respond.</p>
                    </div>
                    <div class="amountstuff vertic end endjust">
                      <small class="bold blue">for</small>
                      <p class="bold blue"><sc-tokenbalanceformatter value="{{item.amount}}"></sc-tokenbalanceformatter></p>
                    </div>
                  </template>

                  <!-- Provider accepted -->
                  <template is="dom-if" if="{{_is(dealstate,'provideraccepted')}}">
                    <div class="flex vertic start startjust">
                        <p class="hashtagdealmsg totalwidth grey4">{{currentprovider.username}} has accepted a deal with you.</p>
                    </div>
                    <div class="amountstuff vertic end endjust">
                      <small class="bold green">for</small>
                      <p class="bold green"><sc-tokenbalanceformatter value="{{item.amount}}"></sc-tokenbalanceformatter></p>
                    </div>
                  </template>

                  <!-- In deal. -->
                  <template is="dom-if" if="{{_is(dealstate,'indeal')}}">
                    <div class="flex vertic start startjust">
                        <template is="dom-if" if="{{!phoneview}}">
                          <p class="hashtagdealmsg totalwidth grey4"><span class="bold">You're in a deal</span> with {{currentprovider.username}}.</p>
                        </template>
                        <template is="dom-if" if="{{phoneview}}">
                          <p class="hashtagdealmsg totalwidth grey4"><span class="bold">In deal</span> with {{currentprovider.username}}.</p>
                        </template>
                        <p class="small totalwidth grey2b">Ready to be paid out.</p>
                    </div>
                    <div class="amountstuff vertic end endjust">
                      <small class="bold green">for</small>
                      <p class="bold green"><sc-tokenbalanceformatter value="{{item.amount}}"></sc-tokenbalanceformatter></p>
                    </div>
                  </template>


              </div>

              <div class="lid totalwidth"></div>
          </div>
        </template>

      </template>

</template>


  <script>
    Polymer({

      is: 'sc-hashtagitem',

      observers: [
        '_log(dealstate)',
        '_item(item,identity)'
      ],

      properties: {
        /**
       * `` .
       */
        item: {
          type: Object,
        },
        identity: {
          type: Object,
          statePath: 'identity',
        },
        yourreply: {
          type: String
        }
      },

      ready: function(){
      },

      /**
      * 'onEnter' are the behaviors that occur when the router tells this component enters the stage
      * use this to initialize any variables to start the component
      */
      onEnter: function(){
      },

      /**
      * 'onExit' are the behaviors that occur when the router tells this component to leave the stage
      * use this to reset any variables when leaving this component while it remains loaded.
      */
      onExit: function(){
      },

      toDetail: function(){
        this.fire('to-detail',this.item);
      },


      toDealForTwoSeeker: function(e) {
        this.fire('redirect', {
          target: '/dealfortwoseeker/' + this.item.hashtag + '/' + this.item.id + '/' + this.item.selectedreply
        });
      },

      toDealForTwoProvider: function(e) {
        this.fire('redirect', {
          target: '/dealfortwoprovider/' + this.item.hashtag + '/' + this.item.id + '/' + this.item.selectedreply
        });
      },

      toggleItem: function(){
        //console.log('*toggleitem*',this.item);

        var toggler = this.shadowRoot.getElementById('repliescollapser');
        if(this.iamprovider){
          this.fire('redirect', {
            target: '/dealfortwoprovider/' + this.item.hashtag + '/' + this.item.id + '/' + this.item.selectedreply
          });
        } else {

        if (toggler.opened) {

          this.customStyle['--my-totalbg-color'] = 'rgba(255,255,255,0.25)';
          this.updateStyles();
          toggler.opened = false;
          if (this.dealmessage) {
            this.showdealmsg = true;
          };
        } else {
          toggler.opened = true;
          this.customStyle['--my-totalbg-color'] = 'var(--sc-white)';
          this.updateStyles();
          this.showdealmsg = false;

        }
}
        // this.checkDealmsg();

      },

      toLocaltime: function(target){
        // console.log("HEY MISTER? got the tiiiimmmmmeeeeee",target);

      },




      youareowner: function(pubkey){
        //debugger;
        return (this.identity.pubkey == pubkey);
      },


      _item: function(){
        var self = this;
        var deal = this.item;
          if(deal.ireplied) {
            self.showdealmsg = true;
            self.dealmessage = "You replied to this.";
            self.dealmessageclass = "grey4";
          } else {
            self.showdealmsg = false;
          }

          // this slice is neccesary to prevent a polymer databinding flaw..

          if (deal.replies){
            this.itemreplies = deal.replies.slice(0);
          }

          if(deal.selectedreply) {

            var foundReply = deal.replies.find(function(item){
              return item.id === deal.selectedreply;
            });

            if (foundReply){
              self.currentprovider = foundReply.provider;
                if(self.currentprovider.pubkey === self.identity.pubkey) {
                  self.dealmessage = deal.seeker.username+" chose you for this request!";
                  self.dealmessagechosen = "";
                  self.dealmessageclass = "blue";
                  self.iamprovider = true;
                  self.showdealmsg = false;
                  //debugger;
                } else {
                self.dealmessage = "";
                self.dealmessagechosen = deal.seeker.username+" chose "+self.currentprovider.username+" for this request.";
              }
            }
          }

      },


      _log: function(target){
          console.log("HAZ THIS in hashtagitem??!!!!",this.item.msg, target);
      },



      /**
      * '_is', a function to bind a template to a certain value of a variable.
      */
      _is: function(a, b) {
        if (b === undefined){
          b = true;
        }
        return a === b;
      },

    });
  </script>
</dom-module>
